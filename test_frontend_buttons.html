<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Company Buttons</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            margin: 5px; 
            padding: 12px 24px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .primary { background: #1976d2; color: white; }
        .danger { background: #d32f2f; color: white; }
        .success { color: #2e7d32; background: #e8f5e9; padding: 10px; border-radius: 4px; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; }
        .info { color: #1976d2; background: #e3f2fd; padding: 10px; border-radius: 4px; }
        .log-entry { 
            margin: 5px 0; 
            padding: 8px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px;
        }
        .company-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .actions {
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .modal-actions {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Frontend Company Buttons</h1>
        
        <div class="test-section">
            <h3>üìä System Status</h3>
            <div id="systemStatus">Checking...</div>
        </div>
        
        <div class="test-section">
            <h3>üè¢ Companies List</h3>
            <div id="companiesList">Loading...</div>
        </div>
        
        <div class="test-section">
            <h3>üìã Console Logs</h3>
            <div id="logs"></div>
        </div>
    </div>

    <!-- Modal for Details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Company Details</div>
            <div id="detailsContent">Loading...</div>
            <div class="modal-actions">
                <button onclick="closeDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Confirm Delete</div>
            <div id="deleteContent">Are you sure you want to delete this company?</div>
            <div class="modal-actions">
                <button onclick="closeDeleteModal()">Cancel</button>
                <button class="danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let authToken = null;
        let companies = [];
        let selectedCompany = null;
        
        // Override console methods to display in page
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('info', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warning', args.join(' '));
        };
        
        function addLog(type, message) {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Login function
        async function login() {
            try {
                console.log('üîê Attempting login...');
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@tractoreando.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    console.log('‚úÖ Login successful');
                    updateSystemStatus('‚úÖ Authenticated');
                    return true;
                } else {
                    console.error('‚ùå Login failed:', data);
                    updateSystemStatus('‚ùå Authentication failed');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                updateSystemStatus('‚ùå Login error');
                return false;
            }
        }
        
        // Update system status
        function updateSystemStatus(status) {
            document.getElementById('systemStatus').innerHTML = status;
        }
        
        // Load companies
        async function loadCompanies() {
            try {
                console.log('üìã Loading companies...');
                const response = await fetch(`${API_BASE}/companies`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok && data.companies) {
                    companies = data.companies;
                    console.log(`‚úÖ Loaded ${companies.length} companies`);
                    renderCompanies();
                } else {
                    console.error('‚ùå Failed to load companies:', data);
                    document.getElementById('companiesList').innerHTML = '<div class="error">Failed to load companies</div>';
                }
            } catch (error) {
                console.error('‚ùå Error loading companies:', error);
                document.getElementById('companiesList').innerHTML = '<div class="error">Error loading companies</div>';
            }
        }
        
        // Render companies list
        function renderCompanies() {
            const container = document.getElementById('companiesList');
            if (companies.length === 0) {
                container.innerHTML = '<div class="info">No companies found</div>';
                return;
            }
            
            let html = '';
            companies.forEach(company => {
                html += `
                    <div class="company-card">
                        <h4>${company.name}</h4>
                        <p><strong>CIF:</strong> ${company.cif}</p>
                        <p><strong>Status:</strong> ${company.isActive ? 'Active' : 'Inactive'}</p>
                        <div class="actions">
                            <button class="primary" onclick="handleViewDetails('${company.id}')">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="danger" onclick="handleDelete('${company.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // Handle view details
        async function handleViewDetails(companyId) {
            try {
                console.log(`üëÅÔ∏è Viewing details for company: ${companyId}`);
                selectedCompany = companies.find(c => c.id === companyId);
                
                if (!selectedCompany) {
                    console.error('‚ùå Company not found in local list');
                    return;
                }
                
                // Fetch detailed company data
                const response = await fetch(`${API_BASE}/companies/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const companyDetails = await response.json();
                    console.log('‚úÖ Company details loaded successfully');
                    showDetailsModal(companyDetails);
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå Failed to load company details:', errorData);
                    alert('Failed to load company details: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('‚ùå Error in handleViewDetails:', error);
                alert('Error loading company details: ' + error.message);
            }
        }
        
        // Handle delete
        function handleDelete(companyId) {
            console.log(`üóëÔ∏è Initiating delete for company: ${companyId}`);
            selectedCompany = companies.find(c => c.id === companyId);
            
            if (!selectedCompany) {
                console.error('‚ùå Company not found in local list');
                return;
            }
            
            showDeleteModal();
        }
        
        // Show details modal
        function showDetailsModal(companyDetails) {
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('detailsContent');
            
            content.innerHTML = `
                <h4>${companyDetails.name}</h4>
                <p><strong>CIF:</strong> ${companyDetails.cif}</p>
                <p><strong>Status:</strong> ${companyDetails.isActive ? 'Active' : 'Inactive'}</p>
                <p><strong>Address:</strong> ${companyDetails.address ? 
                    [companyDetails.address.street, companyDetails.address.city, companyDetails.address.state]
                    .filter(Boolean).join(', ') : 'Not specified'}</p>
                <p><strong>Contact:</strong> ${companyDetails.contact?.email || 'Not specified'}</p>
                <p><strong>Phone:</strong> ${companyDetails.contact?.phone || 'Not specified'}</p>
            `;
            
            modal.style.display = 'block';
        }
        
        // Show delete modal
        function showDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('deleteContent');
            
            content.innerHTML = `Are you sure you want to delete <strong>${selectedCompany.name}</strong>?`;
            modal.style.display = 'block';
        }
        
        // Close modals
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            selectedCompany = null;
        }
        
        // Confirm delete
        async function confirmDelete() {
            if (!selectedCompany) {
                console.error('‚ùå No company selected for deletion');
                return;
            }
            
            try {
                console.log(`üóëÔ∏è Deleting company: ${selectedCompany.name} (${selectedCompany.id})`);
                
                const response = await fetch(`${API_BASE}/companies/${selectedCompany.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Company deleted successfully:', data.message);
                    closeDeleteModal();
                    // Reload companies list
                    await loadCompanies();
                } else {
                    console.error('‚ùå Delete failed:', data);
                    alert('Delete failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('‚ùå Error in confirmDelete:', error);
                alert('Error deleting company: ' + error.message);
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const detailsModal = document.getElementById('detailsModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target === detailsModal) {
                closeDetailsModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        }
        
        // Initialize
        window.onload = async function() {
            console.log('üöÄ Initializing test page...');
            updateSystemStatus('üîÑ Initializing...');
            
            const loginSuccess = await login();
            if (loginSuccess) {
                await loadCompanies();
            } else {
                document.getElementById('companiesList').innerHTML = '<div class="error">Authentication required</div>';
            }
        };
    </script>
</body>
</html>